#!/usr/bin/env python2
#
# Copyright ClusterHQ Inc.  See LICENSE file for details.

"""
Publish build artifacts.

Travis calls this during the `after_script` phase of its build lifecycle.
 * https://docs.travis-ci.com/user/customizing-the-build

Set ``FLOCKER_BUILDER`` environment variable before calling this script.
"""

from os import environ
from subprocess import call


def publish_staging_docs(build_directory):
    """
    Copy the HTML generated by the docs-html build to an S3 bucket.
    """
    expected_variables = (
        "TRAVIS_TAG",
        "TRAVIS_PULL_REQUEST_BRANCH",
        "TRAVIS_BRANCH"
    )
    for travis_name in expected_variables:
        target_directory = environ.get(travis_name)
        if target_directory:
            break
    else:
        raise KeyError(
            "os.environ did not contain any of the expected variables",
            expected_variables
        )

    return call([
        "aws", "--region", "us-east-1", "s3", "sync",
        "--delete",
        "build/" + build_directory,
        "s3://clusterhq-staging-docs/" + target_directory
    ])


HANDLERS = {
    "docs-html": publish_staging_docs,
}


def main():
    handler_name = environ["FLOCKER_BUILDER"]
    handler = HANDLERS.get(handler_name)
    if handler:
        return handler(handler_name)

if __name__ == "__main__":
    raise SystemExit(main())
